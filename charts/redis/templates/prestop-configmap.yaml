{{- if and .Values.sentinel.enabled (eq .Values.architecture "replication") }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "redis.fullname" . }}-prestop-script
  namespace: {{ include "common.namespace" . }}
  labels:
    {{- include "redis.labels" . | nindent 4 }}
data:
  prestop.sh: |
    #!/bin/bash

    # Redis master failover script for graceful shutdown
    # Based on Bitnami Redis charts failover handling

    set -e

    # Configuration
    REDIS_PORT="{{ .Values.service.port }}"
    SENTINEL_PORT="{{ .Values.sentinel.port }}"
    MASTER_NAME="{{ .Values.sentinel.masterName }}"
    HEADLESS_SERVICE="{{ include "redis.fullname" . }}-headless.{{ include "common.namespace" . }}.svc.cluster.local"
    REDIS_SERVICE="{{ include "redis.fullname" . }}.{{ include "common.namespace" . }}.svc.cluster.local"

    # Set authentication if enabled
    {{- if .Values.auth.enabled }}
    export REDISCLI_AUTH="${REDIS_PASSWORD}"
    {{- end }}

    # Set loopback address based on ipFamily configuration
    {{- if eq .Values.ipFamily "ipv6" }}
    REDIS_LOOPBACK="::1"
    {{- else }}
    REDIS_LOOPBACK="127.0.0.1"
    {{- end }}

    # Function to run Redis commands
    run_redis_command() {
        local args=("-h" "$REDIS_LOOPBACK" "-p" "$REDIS_PORT")
        redis-cli "${args[@]}" "$@"
    }

    # Function to check if current instance is master
    is_master() {
        REDIS_ROLE=$(run_redis_command role | head -1)
        [[ "$REDIS_ROLE" == "master" ]]
    }

    # Function to get full hostname for a pod
    get_full_hostname() {
        hostname="$1"
        full_hostname="${hostname}.${HEADLESS_SERVICE}"
        echo "${full_hostname}"
    }

    # Function to run Sentinel commands
    run_sentinel_command() {
        redis-cli -h "$REDIS_SERVICE" -p "$SENTINEL_PORT" {{- if .Values.auth.enabled }} -a "${REDIS_PASSWORD}"{{- end }} sentinel "$@"
    }

    # Function to check if sentinel failover has finished
    sentinel_failover_finished() {
        REDIS_SENTINEL_INFO=($(run_sentinel_command get-master-addr-by-name "$MASTER_NAME" 2>/dev/null || echo ""))
        if [ ${#REDIS_SENTINEL_INFO[@]} -ge 1 ]; then
            REDIS_MASTER_HOST="${REDIS_SENTINEL_INFO[0]}"
            [[ "$REDIS_MASTER_HOST" != "$(get_full_hostname $HOSTNAME)" ]]
        else
            # If we can't get master info, assume failover is complete
            return 0
        fi
    }

    # Function to wait with retries
    retry_while() {
        local condition="$1"
        local max_attempts="$2"
        local sleep_time="$3"
        local attempt=0

        while [ $attempt -lt $max_attempts ]; do
            if $condition; then
                return 0
            fi
            sleep "$sleep_time"
            ((attempt++))
        done
        return 1
    }

    echo "Redis preStop hook starting for pod: $HOSTNAME"

    # Only proceed with failover if this instance is the master
    if is_master; then
        echo "I am the master pod and I'm being stopped. Initiating graceful failover."

        # Pause client write connections to prevent data loss during failover
        echo "Pausing client write connections for 22 seconds to prevent data loss..."
        if run_redis_command CLIENT PAUSE "22000" WRITE; then
            echo "Client write connections paused successfully"
        else
            echo "Warning: Failed to pause client connections, continuing anyway"
        fi

        # Issue failover command to Sentinel
        echo "Issuing failover command to Sentinel..."
        if run_sentinel_command failover "$MASTER_NAME"; then
            echo "Failover command sent successfully"
        else
            echo "Warning: Failed to send failover command, Sentinel may handle this automatically"
        fi

        # Wait for Sentinel to complete the failover
        echo "Waiting for Sentinel to complete failover (up to 20 seconds)..."
        if retry_while "sentinel_failover_finished" "20" "1"; then
            echo "Sentinel failover completed successfully"
        else
            echo "Warning: Failover may still be in progress or Sentinel unavailable"
        fi

        # Additional delay to ensure new master is fully established
        echo "Allowing additional time for new master to stabilize..."
        sleep 3

    else
        echo "I am not the master, no failover needed"
    fi

    echo "Redis preStop hook completed"
    exit 0
{{- end }}